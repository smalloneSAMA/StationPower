<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    

    <title>通信网优化</title>

    <link rel="shortcut icon" href="favicon.ico">
    <link href="css/bootstrap.min.css?v=3.3.5" rel="stylesheet">
    <link href="css/font-awesome.min.css?v=4.4.0" rel="stylesheet">

    <link href="css/animate.min.css" rel="stylesheet">
    <link href="css/style.min.css?v=4.0.0" rel="stylesheet"><base target="_blank">
    <link rel="stylesheet" href="layer/skin/default/layer.css">

</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
		<div class="row" >
			<div class="col-sm-12" >
				<div class="ibox">
                    <div class="ibox-content text-center">
                        <h2 class="m-b-xxs"><b>二、业务路由分配</b></h2>
                    </div>
					<div class="white-bg dashboard-header">
						<p>对每条业务先通过Dijkstra算法求出前n条最短路径，初始化每条业务选择的路由分配方案，再通过遗传算法，选择、交叉、变异进入下一代，直到算法终止。</p>
						<p>算法终止的条件：采用三个指标网络总风险度：通信网中所有资源（设备和光缆）的风险度之和（取最小值）；
资源风险均衡度：网络中设备和光缆风险度的方差和的倒数，代表网路风险均摊在资源上（取最大值）；
业务风险均衡度：网络中业务风险度方差的倒数，代表网路风险均摊在业务上（取最大值）。</p>
					</div>
                </div>
			</div>
		</div>

        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>低可靠性业务Top5</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="dropdown-toggle" data-toggle="dropdown" href="table_basic.html#">
                                <i class="fa fa-wrench"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-user">
                                <li><a href="table_basic.html#">选项1</a>
                                </li>
                                <li><a href="table_basic.html#">选项2</a>
                                </li>
                            </ul>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <table class="table table-striped table-bordered table-hover dataTables-example">
                            <thead>
                            <tr >
                                <th style="text-align: center">序号</th>
                                <th style="text-align: center">业务名称</th>
                                <th style="text-align: center">业务ID</th>
                                <th style="text-align: center">业务可靠性</th>
                                <th style="text-align: center">操作</th>
                            </tr>
                            </thead>
                            <tbody id="LowReliability">

                            </tbody>

                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" style="padding: 13px 0px">
            <div class="col-xs-2">
                <select class="form-control" id="Province" name="cars" >
                    <!--<option value="安徽">安徽</option>-->
                    <!--<option value="北京">北京</option>-->
                    <!--<option value="福建">福建</option>-->
                    <!--<option value="甘肃">甘肃</option>-->
                    <!--<option value="河北">河北</option>-->
                    <!--<option value="河南">河南</option>-->
                    <!--<option value="黑龙江">黑龙江</option>-->
                    <!--<option value="吉林">吉林</option>-->
                    <!--<option value="江苏">江苏</option>-->
                    <option value="江西" selected>江西</option>
                    <!--<option value="蒙东">蒙东</option>-->
                    <!--<option value="宁夏">宁夏</option>-->
                    <!--<option value="青海">青海</option>-->
                    <!--<option value="陕西">陕西</option>-->
                    <!--<option value="天津">天津</option>-->
                    <!--<option value="西藏">西藏</option>-->
                    <!--<option value="浙江">浙江</option>-->
                    <!--<option value="重庆">重庆</option>-->
                </select>
            </div>

            <div class="col-xs-2" style="padding-left: 0px">
                <input id="buz_id" type="text" name="业务ID" placeholder="请输入路由业务ID" value="34388FE8-3DD7-4417-91FF-B1E19A527063-24825" class="form-control">
            </div>

            <div class="col-xs-8 no-margins no-padding">

                <button  class="btn btn-white " type="button" onclick="loadPath()" value="查询" style="width: 15%;color:#ffffff;background-color: #1ab394;">查&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;询</button>
            </div>
        </div>

		<div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title" style="border: 0px;">
                        <h5>路径分配图</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="dropdown-toggle" data-toggle="dropdown" href="graph_flot.html#">
                                <i class="fa fa-wrench"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-user">
                                <li><a href="graph_flot.html#">选项1</a>
                                </li>
                                <li><a href="graph_flot.html#">选项2</a>
                                </li>
                            </ul>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <div id="distribute" style="width:100%;height:1000px;"></div>
                    </div>
                </div>
            </div>
        </div>
	</div>
	<script src="js/jquery.min.js?v=2.1.4"></script>
    <script src="js/bootstrap.min.js?v=3.3.5"></script>
    <script src="js/content.min.js?v=1.0.0"></script>
	<script src="S_js/echarts.js"></script>
    <script src="S_js/anhui.js"></script>
    <script src="S_js/beijing.js"></script>
    <script src="S_js/fujian.js"></script>
    <script src="S_js/gansu.js"></script>
    <script src="S_js/hebei.js"></script>
    <script src="S_js/henan.js"></script>
    <script src="S_js/heilongjiang.js"></script>
    <script src="S_js/jilin.js"></script>
    <script src="S_js/jiangsu.js"></script>
    <script src="S_js/jiangxi.js"></script>
    <script src="S_js/neimenggu.js"></script>
    <script src="S_js/ningxia.js"></script>
    <script src="S_js/qinghai.js"></script>
    <script src="S_js/shanxi1.js"></script>
    <script src="S_js/tianjin.js"></script>
    <script src="S_js/xizang.js"></script>
    <script src="S_js/zhejiang.js"></script>
    <script src="S_js/chongqing.js"></script>
    <script src="S_js/china.js"></script>
    <script src="layer/layer.js"></script>
</body>

<script type="text/javascript">
    $(document).ready(function(){

        LowReliability();

    });


    /*
	 * 路由分配
	 */
    function LowReliability() {
        var Province = $("#Province").val();
        var html="";
        $.ajax({
            url: "../../BusinessRoute/LowReliability",
            type: "post",
            dataType : "json",
            data:"Province="+Province,
            success: function (data){
                $.each(data.LowReliability,function (i,item) {
                    html+=" <tr class=\"gradeA\" >"+
                        "<td style='text-align: center ;width:10%;' >"+(i+1)+"</td>"+
                        "<td style='text-align: center;width: 30%'>"+item.name+"</td>"+
                        "<td style='text-align: center;width: 30%'>"+item.obj_ID+"</td>"+
                        "<td class=\"center\" style='text-align: center;width: 15%'>"+item.buzRe+"</td>"+
                        "<td class=\"center\" style='text-align: center;width: 15%'><span class='label label-info' style='cursor:pointer' onclick='refresh(this)'>查询</span></td>"+
                        "</tr>";
                    if(i>9){return false;}
                } );
                $("#LowReliability").html(html);
                loadPath();
            }
        });
        
    }

    function refresh(obj) {

        var obj_id = $(obj).parent().parent().find("td:eq(2)").text();

        $("#buz_id").val(obj_id);

        loadPath();

        $("html,body").animate({scrollTop:$("#distribute").offset().top},1000)

    }
    

	/*
	 * 路由分配
	 */


	function loadPath(){
        var Province = $("#Province").val();

        //获取站点数据
        $.ajax({
            url: "../../StationProperty/StationFilterForRote",
            type: "post",
            dataType: "json",
            async: false,
            data:"Province="+Province,
            success: function (data) {


                Line(data);

            },
            error: function (data) {
                if (data.result == "error") {
                    alert("出现异常");
                }
            }
        });

    }



    function Line(obj) {

        var geoCoordMap1 = new Array();
        var station1 = new Array();
        var example1 ;
        var Province = $("#Province").val();
        var buz_id = $("#buz_id").val();
//        var obj_id2 = $("#obj_id2").val();

        $.each(obj,function (i,item) {
//            站点GIS坐标
            geoCoordMap1[item.Name] = [item.xAxis,item.yAxis];
//            站点属性
            example1={
                name : item.Name,
                businessNum : item.BusinessNum,
                kuorong : item.KuoRong,
                portOcc:item.portOcc,
                buzNumRate:item.buzNumRate,
                increaseRate:item.increaseRate

            };
//            每个站点的数据
            station1[i]= example1;
//            alert(station[i]);
        });



	var myChart1 = echarts.init(document.getElementById('distribute'));

        myChart1.clear();

	// 每个站点的GIS数据
//	var geoCoordMap1 = {
//		'220kV垱岭变':[117.12,28.97],
//		'220kV上饶变':[117.85,28.43],
//		'220kV茅家岭变':[117.99,28.43],
//		'上饶供电公司':[117.97,28.50]
//		//'220kV向塘变':[115.93,28.55],
//		//'220kV梧岗变':[115.80,28.55]
//	};
	
	// 各个站点的相关属性
//	var station1 = [
//		{name:'220kV垱岭变',businessNum:212,kuorong:0.75},
//		{name:'220kV上饶变',businessNum:207,kuorong:0.67},
//		{name:'220kV茅家岭变',businessNum:179,kuorong:0.67},
//		{name:'上饶供电公司',businessNum:164,kuorong:0.3}
//		//{name:'220kV向塘变',businessNum:25,kuorong:0.67},
//		//{name:'220kV梧岗变',businessNum:74,kuorong:0.43}
//	];
        //获取路由
        $.ajax({
            url: "../../BusinessRoute/select",
            type: "post",
            dataType: "json",
            async: false,
            data:"Province="+Province+"&buz_id="+buz_id,
            success: function (data) {

            if(data[0].result!=false) {
                StationPath(data);
            }else {
                alert("无法查询到该省的此路由ID，请确认省份与ID");
            }

            },
            error: function (data) {
                if (data.result == "error") {
                    alert("出现异常");
                }
            }
        });


        function StationPath(obj){
            var edges1 = new Array();
            var name11;
            var name22;
            var result;
            var startName = obj[0].start;
            var endName = obj[0].end;
            //取出路由信息
            $.each(obj,function (i,item) {
//                result=item.result;
                name11={
                    name:item.name1
                };
                name22={
                    name:item.name2,
                    fiberOcc: item.FiberOcc,
                    from:item.name1,
                    to:item.name2,
                    route:item.route
                };
                edges1[i]=[name11,name22];

            });
//            if(result.equals("error")){
//                alert("无法查询到该省的此路由ID，请确认省份与ID");
//            }



	// 各个站点之间的连接情况
//	var edges1 = [
//		[{name:'220kV垱岭变'}, {name:'220kV上饶变',fiberOcc:0.56}],
//		[{name:'220kV上饶变'}, {name:'220kV茅家岭变',fiberOcc:0.3}],
//		[{name:'220kV茅家岭变'}, {name:'上饶供电公司',fiberOcc:0.3}]
//		//[{name:'220kV向塘变'}, {name:'220kV梧岗变',fiberOcc:0.3}]
//	];

	var planePath = 'path://M1705.06,1318.313v-89.254l-319.9-221.799l0.073-208.063c0.521-84.662-26.629-121.796-63.961-121.491c-37.332-0.305-64.482,36.829-63.961,121.491l0.073,208.063l-319.9,221.799v89.254l330.343-157.288l12.238,241.308l-134.449,92.931l0.531,42.034l175.125-42.917l175.125,42.917l0.531-42.034l-134.449-92.931l12.238-241.308L1705.06,1318.313z';

	var convertData1 = function (data) {
		var res = [];
		for (var i = 0; i < data.length; i++) {
			var dataItem = data[i];
			var fromCoord = geoCoordMap1[dataItem[0].name];
			var toCoord = geoCoordMap1[dataItem[1].name];
			if (fromCoord && toCoord) {
				res.push({
					//fromName: dataItem[0].name,
					//toName: dataItem[1].name,
					name: "铅芯占用率",
					coords: [fromCoord, toCoord],
					value: dataItem[1].fiberOcc,
                    route: dataItem[1].route,
                    fromName: dataItem[1].from,
                    toName: dataItem[1].to
				});
			}
		}
		return res;
	};


	var color1 = ['#a6c84c', '#ffa022', '#46bee9'];
	
	var series1 = [
		{
			type: 'lines',
			zlevel: 10,
            large: true,
            coordinateSystem: 'geo',
			symbol: ['none', 'none'],
			symbolSize: 10,
			effect: {
				show: true,
				period: 6,
				trailLength: 0,
                symbol: 'pin',
//				symbol: planePath,
				symbolSize: 15
			},
			lineStyle: {
				normal: {
				    color:'#ffffff',
					opacity: 0.6,
					curveness: 0.1,
                    width: 2
				}
			},
            label: {
                normal: {
                    show: true,
                    position: 'middle',
                    formatter: function (val) {
                        var route = val.data.route;
                        if( route == 2){
                            return ('备用线路: '+res.fromName+' 到 '+res.toName)
                        }
                        return ('主线路: '+res.fromName +' 到 '+res.toName)
                    }
                }
            },
			data: convertData1(edges1)
		},
		{//每个站点
			type: 'effectScatter',
			coordinateSystem: 'geo',
            hoverAnimation: true,
            showEffectOn: 'render',
			zlevel: 2,
			rippleEffect: {
				brushType: 'stroke'
			},
			label: {
				normal: {
					show: true,
					position: 'right',
                    formatter: function (val) {
                        var name = val.data.name;
                        if( RegExp(startName).test(name)){
                            return '开始站点'
                        }else if(RegExp(endName).test(name)){
                            return '终止站点'
                        }else{
                            return ''
                        }

                    }
				}
			},
			//symbolSize: function (val) {
				//return val[2] / 8;
			//},
            symbolSize: function (val) {
                x = val[2] * 20;
                if(x < 2){
                    return 1;
                }
                return x;
            },
			data: station1.map(function (dataItem) {
					return {
						name: dataItem.name+' , 业务数：'+dataItem.businessNum+'，扩容迫切性：'+dataItem.kuorong,
						value: geoCoordMap1[dataItem.name].concat([dataItem.kuorong]),
                        portOcc:dataItem.portOcc,
                        buzNumRate:dataItem.buzNumRate,
                        increaseRate:dataItem.increaseRate
					};
				}
			)
		}
	];
	var Province = $("#Province").val();
	option1 = {
//		backgroundColor: '#404a59',//#404a59
		title : {
			text: Province,
			subtext: '路径分配图',
			left: 'center',
			textStyle : {
				color: '#404a59'
			}
		},
		tooltip : {
			trigger: 'item',
			formatter: function (params) {
				if(params.name.indexOf("铅芯占用率") == -1)
					return params.name;
				else
					return params.name+ ' : ' + params.value;
			}
		},
		toolbox:{
			show:true,
			feature:{
				mark:{show:!0},
				//dataView:{show:!0,readOnly:!1},
				restore:{show:!0},
				saveAsImage:{show:!0}
			}
		},
		visualMap: [
			{
				min: 0,
				max: 1,
				text:['高','低'],
				precision:2,
				calculable: false,
                hoverLink:true,
				top:'center',
				inRange: {
					color: ['#50a3ba', '#eac736', '#d94e5d']
				},
				textStyle: {
					color: '#003'
				}
			}
		],
		geo: {
			map: Province,
			label: {
				emphasis: {
					show: false
				}
			},
			roam: true,
			itemStyle: {
				normal: {
					areaColor: '#323c48',
					borderColor: '#ffefd5'//#ffefd5,#404a59
				},
				emphasis: {
					areaColor: '#2a333d',
                    opacity:0
				}
			}
		},
		series: series1
	};

            myChart1.on('click', function (params) {
                var node = params.name;
                var if_exist = RegExp("扩容").test(node);
                if(if_exist){
                    var portOcc = (params.data.portOcc*100).toFixed(2)  + "%";
                    var buzNumRate =(params.data.buzNumRate*100).toFixed(2) + "%";
                    var increaseRate = (params.data.increaseRate*100).toFixed(2)   + "%";

                    layer.config({
                        extend: 'routeSkin/style.css', //同样需要加载新皮肤
                        skin:'layer-ext-yi'
                    });

                    layer.msg("端口占用率："+portOcc+" <br> 承载业务的级别和重要性："+buzNumRate+" <br> 业务数增长率：" +increaseRate, {
                        time: 90000, //5s后自动关闭,
                        btnAlign: 'c',
                        skin:'layer-ext-yi',
//                    btn: ['新增下级问题'],
                        closeBtn: 1,
                        tipsMore:false,
                        yes:function (index, layero) {
                            layer.close(index);
                        }
                    });
                }
            });

	// 使用刚指定的配置项和数据显示图表。
    myChart1.setOption(option1);
	$(window).resize(myChart1.resize);
    }

    }

</script>